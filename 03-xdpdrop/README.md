# 🛡️ eBPF XDP Example: Block Specific Destination IPs

This example demonstrates how to write an eBPF program in C and load it using Go and the [`cilium/ebpf`](https://github.com/cilium/ebpf) library.  
The program attaches to the XDP hook on a network interface and blocks packets sent to a specific destination IP (e.g. `127.0.0.1`).

It also tracks how many packets were dropped per destination IP and prints the results in the Go program.

---

## 📦 What You’ll See

Every time a packet is dropped due to matching the blocked IP, the program will log something like:

```shell
📊 Blocked destination IPs:
- 127.0.0.1: 3 packets dropped
```

This gives live insight into how many packets are being dropped by your eBPF logic.

![demo.gif](assets/demo.gif)
<sub>*created with [vhs](https://github.com/charmbracelet/vhs) by Charm CLI*</sub>
---

## 🚀 How to Run

### 1. Install Prerequisites

Please see the instructions in the main [README](./../README.md).  
Make sure your system includes `clang`, `llvm`, `libbpf-dev`, and `linux-headers`.

If using a Lima VM, ensure kernel headers are available in:

```
/usr/src/linux-headers/usr/include
```

(You may need to clone the kernel and run `make headers_install`.)

### 2. Generate Go Bindings

```bash
go generate
```

This runs `bpf2go` with appropriate flags to compile [`xdpdrop.c`](./xdpdrop.c) and generate Go bindings.

### 3. Run the Program

Attach the program to a local interface (e.g. `lo` for loopback):

```bash
sudo go run .
```

You’ll see something like:

```shell
eBPF program attached to interface lo
📊 Blocked destination IPs:
- 127.0.0.1: 1 packets dropped
- 127.0.0.1: 4 packets dropped
```

### 4. Trigger Blocked Traffic

In another terminal:

```bash
ping 127.0.0.1
```

This will be dropped by the eBPF program and reflected in your Go logs.

### 5. Exit

Use `Ctrl+C` to stop the program cleanly.

---

## 📂 File Structure

```text
.
├── main.go              # Go program that loads and attaches the XDP eBPF program
├── xdpdrop.c            # eBPF program written in C
├── xdpdrop_bpfel.go     # Auto-generated by bpf2go for little-endian systems
├── xdpdrop_bpfeb.go     # Auto-generated by bpf2go for big-endian systems
├── go.mod
├── go.sum
```

---
## 🛠 Notes

- The destination IP is hardcoded in the C file as:

```c
#define BLOCKED_IP 0x7f000001 // 127.0.0.1
```