# ðŸ“¦ eBPF Packet Counter with source IPs

This example demonstrates a minimal eBPF program written in C, loaded and controlled using Go with the [`cilium/ebpf`](https://github.com/cilium/ebpf) library.

It attaches to a network interface via **XDP** and counts incoming packets grouped by **source IP**.


## âœ¨ What It Does

- Attaches an eBPF program to a given interface (default: `eth0`)
- Parses packets and tracks how many came from each source IP
- Every second, logs the per-IP packet counts in the Go program

Perfect for learning eBPF/XDP or debugging interface-level packet flow.

## ðŸ“¦ What Youâ€™ll See

![demo.gif](assets/demo.gif)
<sub>*created with [vhs](https://github.com/charmbracelet/vhs) by Charm CLI*</sub>

Whenever you trigger packets (e.g. with `ping`), youâ€™ll see logs like:
```shell
2025/06/25 17:28:31 Counting incoming packets on eth0...
2025/06/25 17:28:32 ðŸ“¥ Packet count by source IP:
2025/06/25 17:28:32 - 2.5.168.192: 1 packets
2025/06/25 17:28:33 ðŸ“¥ Packet count by source IP:
2025/06/25 17:28:33 - 2.5.168.192: 2 packets
2025/06/25 17:28:34 ðŸ“¥ Packet count by source IP:
2025/06/25 17:28:34 - 2.5.168.192: 3 packets
2025/06/25 17:28:35 Exiting...
```

---
## ðŸš€ How to Run

### 1. Install Prerequisites

Please see the instructions in the main [README](./../README.md)

### 2. Generate eBPF bindings

```bash
go generate
```

This uses `bpf2go` to compile the eBPF C code [`counter.c`](./counter.c) and generate Go bindings.

This uses bpf2go to compile counter.c and create:
- `counter_bpfel.o` â€“ the compiled eBPF object file
- `counter_bpfel.go` â€“ auto-generated Go bindings

### 3. Build and Run

```shell
sudo go run .
```

To use a different interface (e.g., lima0):
```shell
sudo go run . -iface=lima0
```
You'll need `sudo` to attach to XDP and access eBPF maps.

Youâ€™ll see live packet counts grouped by source IP.

### 4. Trigger packets from macOS host (with Lima and `socket_vmnet`)

<details>
<summary>Click to expand</summary>

This section explains how to test your eBPF program by sending packets **from your macOS host to the Lima VM** using `socket_vmnet` (bridged networking).

#### 1. Lima configuration

Ensure your `lima.yaml` includes bridged networking:

```yaml
networks:
  - lima: shared
```

This enables a virtual network where your host and VM can communicate directly.

#### 2.Find the VMâ€™s bridged IP

Inside the Lima VM, run:
```shell
ip a s lima0
```

You should see output like:
```shell
3: lima0: <BROADCAST,MULTICAST,UP,LOWER_UP> ...
inet 192.168.105.2/24 metric 100 brd 192.168.105.255 scope global dynamic lima0
```

Take note of the brd IP (192.168.105.255 in this case) â€” that is the IP of the Lima VM reachable from macOS.

### 3. Run the eBPF program inside the VM
Start the Go program and attach it to the bridged interface:
```shell
sudo go run . --iface=lima0
```

4. Send packets from macOS host
In a separate macOS terminal window, ping the VMâ€™s bridged IP:
```shell
ping -c 3 192.168.105.255
```

Back in the Lima VM, the Go program will log the number of packets received per source IP:
```shell
sudo go run . --iface=lima0
2025/06/25 17:45:47 Counting incoming packets on lima0...
2025/06/25 17:45:48 ðŸ“¥ Packet count by source IP:
2025/06/25 17:45:48 - 1.105.168.192: 1 packets
2025/06/25 17:45:49 ðŸ“¥ Packet count by source IP:
2025/06/25 17:45:49 - 1.105.168.192: 2 packets
2025/06/25 17:45:50 ðŸ“¥ Packet count by source IP:
2025/06/25 17:45:50 - 1.105.168.192: 3 packets
```
</details>


## ðŸ“‚ File Structure
```shell
.
â”œâ”€â”€ main.go               # Go loader, metrics logger, and CLI flag parsing
â”œâ”€â”€ counter.c             # eBPF XDP program (C)
â”œâ”€â”€ counter_bpfel.go      # Go bindings auto-generated by bpf2go
â”œâ”€â”€ go.mod
â”œâ”€â”€ go.sum
```

## ðŸ”’ Permissions
You must run the program with sudo to:
- Attach XDP programs to interfaces
- Access kernel-level BPF APIs and maps

## ðŸ§  Bonus Ideas
- Track destination IP or (src, dst) tuples
- Filter only TCP or UDP traffic
- Log ICMP packets (i.e., pings)
